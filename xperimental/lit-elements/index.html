<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@next/webcomponents-loader.js"></script>
    <script src="https://unpkg.com/nosleep.js@0.7.0/dist/NoSleep.js"></script>
    <script src="./gyro-element.js"
            type="module"></script>
    <script src="./storage-element.js"
            type="module"></script>


</head>

<body>
    <storage-element id="localDB"
                     limitInBytes=1048576></storage-element>
    <gyro-element id="gyro"
                  betasensitivity=2
                  gammasensitivity=10
                  alphasensitivity=2></gyro-element>
    

    <button onclick="download()">Download!</button>

    <script>
        window.onload = boot

        function boot() {
            //No Sleep
            let noSleep = new NoSleep();
            noSleep.enable();
            //End No Sleep

            document.getElementById("localDB").clear();

            document.getElementById("gyro").addEventListener("data-changed", handleData);

        }

        function handleData(e) {
            document.getElementById("localDB").setItem(new Date().getTime(), JSON.stringify(e.detail));
        }

        function download(e) {
            document.getElementById("gyro").removeEventListener("data-changed", handleData)
            document.getElementById("localDB").getAllData("application/octet-stream").then((blob) => {
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = "data.txt";
                link.click();
                URL.revokeObjectURL(url);
                document.getElementById("localDB").clear();
                document.getElementById("gyro").addEventListener("data-changed", handleData);
            });
        }
    </script>
</body>

</html>